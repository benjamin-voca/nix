---
apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
  name: app-db
  namespace: database
spec:
  postgresVersion: 15
  instances:
    - replicas: 2
      dataVolumeClaimName: postgres-volume
      resources:
        requests:
          memory: "512Mi"
          cpu: "250m"
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    postgres-operator.crunchydata.com/cluster: app-db
                topologyKey: kubernetes.io/hostname
  backups:
    pgbackrest:
      repos:
        - name: repo1
          volume:
            volumeClaimSpec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 10Gi
        - name: repo2
          volume:
            volumeClaimSpec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 20Gi
      restore:
        enabled: true
  proxy:
    pgBouncer:
      replicas: 2
      resources:
        requests:
          memory: "64Mi"
          cpu: "50m"
---
apiVersion: v1
kind: Namespace
metadata:
  name: database
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-volume
  namespace: database
  labels:
    postgres-operator.crunchydata.com/cluster: app-db
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
